<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Verse Scroll Live</title>
  <style>
    body {
      margin: 0;
      font-family: 'Georgia', serif;
      background: #d8c6a0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    .edge {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
      background: radial-gradient(ellipse at center, #d8c6a0 70%, #b8a377 100%);
      z-index: -1;
    }
    .wrap {
      background: #fdf6e3;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 800px;
      width: 90%;
      text-align: center;
    }
    .ref {
      font-size: 1em;
      margin-top: 0.8em;
      color: #555;
    }
    .preview {
      opacity: 0.4;
      font-size: 1em;
      margin-top: 1em;
    }
    .unlock {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(4px);
    }
    .unlock .card {
      background: #fff;
      color: #333;
      padding: 18px 22px;
      border-radius: 14px;
      box-shadow: 0 8px 40px rgba(0,0,0,.25);
      text-align: center;
      max-width: 90vw;
    }
    .unlock button {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    #dot {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #c33;
      opacity: .7;
    }
  </style>
</head>
<body>
  <div class="edge"></div>
  <div class="wrap">
    <div id="preview" class="preview"></div>
    <div id="current" class="verse"></div>
    <div id="ref" class="ref"></div>
  </div>

  <audio id="player" preload="auto"></audio>
  <div id="dot"></div>

  <!-- Unlock overlay -->
  <div id="unlock" class="unlock" hidden>
    <div class="card">
      <div><strong>Enable audio</strong></div>
      <div>Tap once so verses can be read aloud.</div>
      <button id="unlockBtn">Enable</button>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const WS_URL = 'wss://tiktoklive-d3qe.onrender.com/ws'; // your Render WS URL

    // ===== ELEMENTS =====
    const elCurrent = document.getElementById('current');
    const elRef     = document.getElementById('ref');
    const elPreview = document.getElementById('preview');
    const elAudio   = document.getElementById('player');
    const elUnlock  = document.getElementById('unlock');
    const elUnlockBtn = document.getElementById('unlockBtn');
    const dot       = document.getElementById('dot');

    // ===== STATE =====
    let q = [];
    let playing = false;
    let audioUnlocked = false;

    // ===== HELPERS =====
    const sleep = ms => new Promise(res => setTimeout(res, ms));
    const green = () => { dot.style.background = '#2bb673'; };
    const red   = () => { dot.style.background = '#c33'; };

    async function showCurrent(item) {
      elCurrent.textContent = item.text || item.ref;
      elRef.textContent = item.ref || '';
    }
    function updatePreview() {
      elPreview.textContent = q[0]?.ref || '';
    }

    // ===== QUEUE =====
    function enqueue(ref, opts={}) {
      q.push({ ref, ...opts });
      updatePreview();
      if (!playing) playLoop();
    }

    async function playLoop() {
      playing = true;
      while (q.length > 0) {
        const item = q.shift();
        await playItem(item);
        updatePreview();
        await sleep(500);
      }
      playing = false;
    }

    async function playItem(item) {
      await showCurrent(item);
      updatePreview();

      if (!audioUnlocked) { await ensureAudioUnlocked(); }
      elAudio.volume = 1;

      // Use pre-generated audio if provided
      if (item.audioUrl) {
        elAudio.src = item.audioUrl;
        try { await elAudio.play(); } catch (e) {}
        await new Promise(res => { elAudio.onended = () => res(); });
        return;
      }

      // Browser TTS fallback
      if ('speechSynthesis' in window) {
        const utter = new SpeechSynthesisUtterance(item.text || item.ref);
        utter.rate = 0.95;
        utter.pitch = 1.0;
        utter.volume = 1;

        const done = new Promise(res => { utter.onend = () => res(); });
        const watchdog = sleep(15000).then(() => {
          try { window.speechSynthesis.cancel(); } catch (_) {}
        });

        try {
          try { window.speechSynthesis.cancel(); } catch (_) {}
          try { window.speechSynthesis.speak(utter); } catch (_) {}
          await Promise.race([done, watchdog]);
        } catch (_) {
          await sleep(4000); // fallback delay
        }
        return;
      }

      // Final fallback
      await sleep(4000);
    }

    // ===== AUDIO UNLOCK =====
    async function ensureAudioUnlocked() {
      if (audioUnlocked) return;
      elUnlock.hidden = false;
      await new Promise(resolve => {
        elUnlockBtn.onclick = async () => {
          try { await elAudio.play(); } catch (_) {}
          try { elAudio.pause(); } catch (_) {}
          if ('speechSynthesis' in window) {
            try {
              const test = new SpeechSynthesisUtterance(' ');
              try { window.speechSynthesis.cancel(); } catch (_) {}
              try { window.speechSynthesis.speak(test); } catch (_) {}
              setTimeout(() => {
                try { window.speechSynthesis.cancel(); } catch (_) {}
              }, 60);
            } catch (_) {}
          }
          audioUnlocked = true;
          elUnlock.hidden = true;
          resolve();
        };
      });
    }

    // ===== WS CONNECT =====
    let ws;
    function connectWS() {
      if (!WS_URL) return;
      ws = new WebSocket(WS_URL);

      ws.onopen = () => { green(); };
      ws.onclose = () => { red(); setTimeout(connectWS, 2500); };
      ws.onerror = () => { red(); };
      ws.onmessage = (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === 'read' && msg.ref) {
            enqueue(msg.ref, { text: msg.text, audioUrl: msg.audioUrl, user: msg.user });
          }
          if (msg.type === 'bulk' && Array.isArray(msg.items)) {
            msg.items.forEach(it => enqueue(it.ref, { text: it.text, audioUrl: it.audioUrl, user: it.user }));
          }
          if (msg.type === 'clear') { q.length = 0; }
          if (!audioUnlocked) { elUnlock.hidden = false; }
        } catch (e) {}
      };
    }
    connectWS();
  </script>
</body>
</html>


